{% extends "base.html" %}

{% block title %}Admin - SeltzerTracker{% endblock %}

{% block content %}
<div class="admin-header">
    <h1>Admin Panel</h1>
</div>

<div class="content">
    <div class="admin-section">
        <h2>Manage Brands</h2>
        
        <div class="brand-management">
            <div class="add-brand-form">
                <h3>Add New Brand</h3>
                <div class="form-group">
                    <input type="text" id="newBrandName" class="form-input" placeholder="Brand name (e.g., Coca-Cola)" required>
                </div>
                <div class="form-group">
                    <input type="text" id="newBrandId" class="form-input" placeholder="Brand ID (optional, auto-generated if empty)">
                </div>
                <div class="form-group">
                    <input type="text" id="initialFlavors" class="form-input" placeholder="Initial flavors (comma-separated, optional)">
                </div>
                <button class="add-brand-btn" onclick="addBrand()">Add Brand</button>
            </div>
            
            <div class="brand-list-section">
                <h3>Existing Brands</h3>
                <ul class="brand-list" id="brandList">
                </ul>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>Manage Flavors</h2>
        
        <div class="brand-selector">
            <select id="brandSelect" onchange="loadBrandFlavors()">
                <option value="">Select a brand to manage flavors...</option>
            </select>
        </div>

        <div class="flavor-management" id="flavorManagement" style="display: none;">
            <h3 id="selectedBrandName">Brand Flavors</h3>
            
            <ul class="flavor-list" id="flavorList">
                <!-- Flavors will be loaded here -->
            </ul>

            <div class="add-flavor-form">
                <input type="text" id="newFlavorInput" class="add-flavor-input" placeholder="Enter new flavor name...">
                <button class="add-flavor-btn" onclick="addFlavor()">Add Flavor</button>
            </div>
        </div>
    </div>

    <div class="admin-section">
        <h2>System Information</h2>
        <div class="flavor-management">
            <p><strong>Total Brands:</strong> <span id="totalBrands">0</span></p>
            <p><strong>Total Flavors:</strong> <span id="totalFlavors">0</span></p>
            <p><strong>Total Reviews:</strong> <span id="totalReviews">0</span></p>
            <p><strong>Active Users:</strong> <span id="activeUsers">0</span></p>
        </div>
    </div>
</div>

<div class="nav-bar">
    <a href="{{ url_for('index') }}" class="nav-item">
        <div class="nav-icon">üè†</div>
        <div>Home</div>
    </a>
    <a href="{{ url_for('log') }}" class="nav-item">
        <div class="nav-icon">üìù</div>
        <div>Log</div>
    </a>
    <a href="{{ url_for('history') }}" class="nav-item">
        <div class="nav-icon">üìä</div>
        <div>History</div>
    </a>
    <a href="{{ url_for('search') }}" class="nav-item">
        <div class="nav-icon">üîç</div>
        <div>Search</div>
    </a>
    <a href="{{ url_for('profile') }}" class="nav-item">
        <div class="nav-icon">üë§</div>
        <div>Profile</div>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
let brands = [];

// Load brands from API
async function loadBrands() {
    try {
        const response = await fetch('/api/brands');
        brands = await response.json();
        
        // Update brand select dropdown
        const brandSelect = document.getElementById('brandSelect');
        brandSelect.innerHTML = '<option value="">Select a brand to manage flavors...</option>';
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name;
            brandSelect.appendChild(option);
        });
        
        // Update brand list
        updateBrandList();
        
        // Update system info
        document.getElementById('totalBrands').textContent = brands.length;
        document.getElementById('totalFlavors').textContent = brands.reduce((total, brand) => total + brand.flavors.length, 0);
    } catch (error) {
        console.error('Error loading brands:', error);
    }
}

// Update the brand list display
function updateBrandList() {
    const brandList = document.getElementById('brandList');
    brandList.innerHTML = '';
    
    brands.forEach(brand => {
        const li = document.createElement('li');
        li.className = 'brand-item';
        li.innerHTML = `
            <div class="brand-info">
                <span class="brand-name">${brand.name}</span>
                <span class="brand-id">(${brand.id})</span>
                <span class="flavor-count">${brand.flavors.length} flavors</span>
            </div>
            <div class="brand-actions">
                <button class="delete-brand-btn" onclick="deleteBrand('${brand.id}', '${brand.name}')">Delete</button>
            </div>
        `;
        brandList.appendChild(li);
    });
}

// Load flavors for selected brand
function loadBrandFlavors() {
    const brandSelect = document.getElementById('brandSelect');
    const selectedBrand = brandSelect.value;
    const flavorManagement = document.getElementById('flavorManagement');
    const selectedBrandName = document.getElementById('selectedBrandName');
    const flavorList = document.getElementById('flavorList');

    if (selectedBrand) {
        const brand = brands.find(b => b.id === selectedBrand);
        if (brand) {
            flavorManagement.style.display = 'block';
            selectedBrandName.textContent = `${brand.name} Flavors`;
            
            // Clear existing flavors
            flavorList.innerHTML = '';
            
            // Add current flavors
            brand.flavors.forEach((flavor, index) => {
                const li = document.createElement('li');
                li.className = 'flavor-item';
                li.innerHTML = `
                    <span class="flavor-name">${flavor}</span>
                    <button class="remove-flavor-btn" onclick="removeFlavor('${selectedBrand}', '${flavor}')">Remove</button>
                `;
                flavorList.appendChild(li);
            });
        }
    } else {
        flavorManagement.style.display = 'none';
    }
}

// Add new flavor
async function addFlavor() {
    const brandSelect = document.getElementById('brandSelect');
    const selectedBrand = brandSelect.value;
    const newFlavorInput = document.getElementById('newFlavorInput');
    const newFlavor = newFlavorInput.value.trim();

    if (!selectedBrand) {
        alert('Please select a brand first.');
        return;
    }

    if (!newFlavor) {
        alert('Please enter a flavor name.');
        return;
    }

    const brand = brands.find(b => b.id === selectedBrand);
    if (brand && brand.flavors.includes(newFlavor)) {
        alert('This flavor already exists for this brand.');
        return;
    }

    try {
        const response = await fetch(`/api/brands/${selectedBrand}/flavors`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ flavor_name: newFlavor })
        });

        if (response.ok) {
            // Update local data
            brand.flavors.push(newFlavor);
            document.getElementById('totalFlavors').textContent = brands.reduce((total, brand) => total + brand.flavors.length, 0);
            
            // Refresh the flavor list
            loadBrandFlavors();
            
            // Clear input
            newFlavorInput.value = '';
            
            alert(`Flavor "${newFlavor}" added successfully!`);
        } else {
            const result = await response.json();
            alert(result.message || 'Error adding flavor');
        }
    } catch (error) {
        console.error('Error adding flavor:', error);
        alert('Error adding flavor. Please try again.');
    }
}

// Remove flavor
async function removeFlavor(brandId, flavorName) {
    if (confirm(`Are you sure you want to remove "${flavorName}" from this brand?`)) {
        try {
            const response = await fetch(`/api/brands/${brandId}/flavors`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ flavor_name: flavorName })
            });

            if (response.ok) {
                // Update local data
                const brand = brands.find(b => b.id === brandId);
                if (brand) {
                    brand.flavors = brand.flavors.filter(f => f !== flavorName);
                    document.getElementById('totalFlavors').textContent = brands.reduce((total, brand) => total + brand.flavors.length, 0);
                }
                
                loadBrandFlavors();
                alert(`Flavor "${flavorName}" removed successfully!`);
            } else {
                const result = await response.json();
                alert(result.message || 'Error removing flavor');
            }
        } catch (error) {
            console.error('Error removing flavor:', error);
            alert('Error removing flavor. Please try again.');
        }
    }
}

// Add new brand
async function addBrand() {
    const brandName = document.getElementById('newBrandName').value.trim();
    const brandId = document.getElementById('newBrandId').value.trim();
    const initialFlavorsInput = document.getElementById('initialFlavors').value.trim();
    
    if (!brandName) {
        alert('Please enter a brand name.');
        return;
    }
    
    // Parse initial flavors
    const initialFlavors = initialFlavorsInput ? 
        initialFlavorsInput.split(',').map(f => f.trim()).filter(f => f) : [];
    
    try {
        const response = await fetch('/api/brands', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                brand_name: brandName,
                brand_id: brandId,
                initial_flavors: initialFlavors
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add to local brands array
            brands.push(result.brand);
            
            // Refresh the display
            loadBrands();
            
            // Clear form
            document.getElementById('newBrandName').value = '';
            document.getElementById('newBrandId').value = '';
            document.getElementById('initialFlavors').value = '';
            
            alert(`Brand "${brandName}" added successfully!`);
        } else {
            alert(result.message || 'Error adding brand');
        }
    } catch (error) {
        console.error('Error adding brand:', error);
        alert('Error adding brand. Please try again.');
    }
}

// Delete brand
async function deleteBrand(brandId, brandName) {
    if (confirm(`Are you sure you want to delete the brand "${brandName}"?\n\nThis action cannot be undone and will remove all flavors associated with this brand.`)) {
        try {
            const response = await fetch(`/api/brands/${brandId}`, {
                method: 'DELETE'
            });
            
            const result = await response.json();
            
            if (result.success) {
                // Remove from local brands array
                brands = brands.filter(b => b.id !== brandId);
                
                // Refresh the display
                loadBrands();
                
                // Clear flavor management if this brand was selected
                const brandSelect = document.getElementById('brandSelect');
                if (brandSelect.value === brandId) {
                    brandSelect.value = '';
                    loadBrandFlavors();
                }
                
                alert(result.message);
            } else {
                alert(result.message || 'Error deleting brand');
            }
        } catch (error) {
            console.error('Error deleting brand:', error);
            alert('Error deleting brand. Please try again.');
        }
    }
}

// Handle Enter key in flavor input
document.getElementById('newFlavorInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addFlavor();
    }
});

// Handle Enter key in brand name input
document.getElementById('newBrandName').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addBrand();
    }
});

// Load brands when page loads
document.addEventListener('DOMContentLoaded', loadBrands);
</script>
{% endblock %}
