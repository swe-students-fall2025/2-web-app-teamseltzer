{% extends "base.html" %}

{% block title %}Search - SeltzerTracker{% endblock %}

{% block content %}
<div class="header">
    <h1>Search Seltzers</h1>
</div>

<div class="content">
    <div class="search-container">
        <div class="search-bar">
            <div class="search-icon">🔍</div>
            <input type="text" id="searchInput" class="search-input" placeholder="Search by brand, flavor, or notes..." autocomplete="off">
            <div class="search-suggestions" id="searchSuggestions" style="display: none;"></div>
        </div>

        <div class="search-filters">
            <button class="filter-chip active" data-filter="all">All</button>
            <button class="filter-chip" data-filter="brand">Brand</button>
            <button class="filter-chip" data-filter="flavor">Flavor</button>
            <button class="filter-chip" data-filter="rating-5">5 Stars</button>
            <button class="filter-chip" data-filter="rating-4">4+ Stars</button>
            <button class="filter-chip" data-filter="polar">Polar</button>
            <button class="filter-chip" data-filter="lacroix">LaCroix</button>
            <button class="filter-chip" data-filter="spindrift">Spindrift</button>
        </div>

        <div class="search-results" id="searchResults">
            <div class="results-header">
                <div class="results-count" id="resultsCount">0 seltzers found</div>
                <button class="sort-btn" onclick="toggleSort()">Sort by Date ↓</button>
            </div>

            <div id="resultsList">
                <!-- Search results will be loaded here -->
            </div>
        </div>

        <div id="noResults" class="no-results" style="display: none;">
            <div class="no-results-icon">🔍</div>
            <h3>No seltzers found</h3>
            <p>Try adjusting your search terms or filters</p>
        </div>
    </div>
</div>

<div class="nav-bar">
    <a href="{{ url_for('index') }}" class="nav-item">
        <div class="nav-icon">🏠</div>
        <div>Home</div>
    </a>
    <a href="{{ url_for('log') }}" class="nav-item">
        <div class="nav-icon">📝</div>
        <div>Log</div>
    </a>
    <a href="{{ url_for('history') }}" class="nav-item">
        <div class="nav-icon">📊</div>
        <div>History</div>
    </a>
    <a href="{{ url_for('search') }}" class="nav-item active">
        <div class="nav-icon">🔍</div>
        <div>Search</div>
    </a>
    <a href="{{ url_for('profile') }}" class="nav-item">
        <div class="nav-icon">👤</div>
        <div>Profile</div>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentQuery = '';
let currentFilter = 'all';
let sortOrder = 'date-desc';
let searchResults = [];

// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    currentQuery = e.target.value;
    performSearch();
});

// Filter functionality
document.querySelectorAll('.filter-chip').forEach(chip => {
    chip.addEventListener('click', function() {
        document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
        this.classList.add('active');
        currentFilter = this.dataset.filter;
        performSearch();
    });
});

async function performSearch() {
    try {
        const params = new URLSearchParams();
        if (currentQuery) params.append('q', currentQuery);
        if (currentFilter !== 'all') params.append('filter', currentFilter);
        
        const response = await fetch(`/api/search?${params}`);
        searchResults = await response.json();
        displayResults(searchResults);
    } catch (error) {
        console.error('Error searching seltzers:', error);
    }
}

function displayResults(results) {
    const resultsList = document.getElementById('resultsList');
    const noResults = document.getElementById('noResults');
    const searchResults = document.getElementById('searchResults');
    
    document.getElementById('resultsCount').textContent = `${results.length} seltzer${results.length !== 1 ? 's' : ''} found`;
    
    if (results.length === 0) {
        resultsList.style.display = 'none';
        searchResults.style.display = 'none';
        noResults.style.display = 'block';
    } else {
        resultsList.style.display = 'block';
        searchResults.style.display = 'block';
        noResults.style.display = 'none';
        
        resultsList.innerHTML = results.map(seltzer => `
            <div class="search-item" data-brand="${seltzer.brand_id}" data-flavor="${seltzer.flavor_id}" data-rating="${seltzer.rating}">
                <div class="search-item-content">
                    <div class="seltzer-info">
                        <h4>${highlightSearchTerm(seltzer.brand)} - ${highlightSearchTerm(seltzer.flavor)}</h4>
                        <p>${formatTimeAgo(seltzer.created_at)}</p>
                    </div>
                    <div class="seltzer-rating">${getStarRating(seltzer.rating)}</div>
                </div>
                <div class="search-actions">
                    <button class="search-action view-action" onclick="viewSeltzer('${seltzer._id}')">👁️</button>
                    <button class="search-action edit-action" onclick="editSeltzer('${seltzer._id}')">✏️</button>
                    <button class="search-action delete-action" onclick="deleteSeltzer('${seltzer._id}')">🗑️</button>
                </div>
            </div>
        `).join('');
    }
}

function highlightSearchTerm(text) {
    if (!currentQuery) return text;
    const regex = new RegExp(`(${currentQuery})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function toggleSort() {
    sortOrder = sortOrder === 'date-desc' ? 'date-asc' : 'date-desc';
    const sortBtn = document.querySelector('.sort-btn');
    sortBtn.textContent = `Sort by Date ${sortOrder === 'date-desc' ? '↓' : '↑'}`;
    
    // Sort results
    searchResults.sort((a, b) => {
        const dateA = new Date(a.created_at);
        const dateB = new Date(b.created_at);
        return sortOrder === 'date-desc' ? dateB - dateA : dateA - dateB;
    });
    
    displayResults(searchResults);
}

// Action functions
function viewSeltzer(id) {
    // For now, just show an alert. In a real app, this would open a detail view
    alert('View functionality - would show seltzer details');
}

function editSeltzer(id) {
    window.location.href = `{{ url_for('edit', seltzer_id='') }}${id}`;
}

async function deleteSeltzer(id) {
    if (confirm('Are you sure you want to delete this seltzer?')) {
        try {
            const response = await fetch(`/api/seltzers/${id}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Remove from search results and refresh display
                searchResults = searchResults.filter(s => s._id !== id);
                displayResults(searchResults);
            } else {
                alert('Error deleting seltzer. Please try again.');
            }
        } catch (error) {
            console.error('Error deleting seltzer:', error);
            alert('Error deleting seltzer. Please try again.');
        }
    }
}

function getStarRating(rating) {
    return '★'.repeat(rating) + '☆'.repeat(5 - rating);
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInHours = Math.floor((now - date) / (1000 * 60 * 60));
    
    if (diffInHours < 1) return 'Just now';
    if (diffInHours < 24) return `${diffInHours} hour${diffInHours > 1 ? 's' : ''} ago`;
    const diffInDays = Math.floor(diffInHours / 24);
    if (diffInDays < 7) return `${diffInDays} day${diffInDays > 1 ? 's' : ''} ago`;
    return date.toLocaleDateString();
}

// Load all seltzers on page load
document.addEventListener('DOMContentLoaded', performSearch);
</script>
{% endblock %}
