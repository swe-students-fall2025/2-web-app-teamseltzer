{% extends "base.html" %}

{% block title %}Edit Seltzer - SeltzerTracker{% endblock %}

{% block content %}
<div class="header">
    <button class="back-btn" onclick="goBack()">‚Üê</button>
    <h1>Edit Seltzer</h1>
</div>

<div class="content">
    <div class="form-container">
        <div class="edit-header">
            <h2>Edit Seltzer Details</h2>
            <div class="edit-actions">
                <button class="delete-btn" onclick="showDeleteModal()">Delete</button>
            </div>
        </div>

        <form id="editSeltzerForm">
            <div class="form-group">
                <label class="form-label" for="brand">Brand</label>
                <select id="brand" class="form-input" required onchange="loadFlavors()">
                    <option value="">Select a brand...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label" for="flavor">Flavor</label>
                <select id="flavor" class="form-input" required disabled>
                    <option value="">Select a brand first...</option>
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Rating</label>
                <div class="rating-container">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
            </div>

            <div class="date-time">
                <div class="form-group">
                    <label class="form-label" for="date">Date</label>
                    <input type="date" id="date" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="time">Time</label>
                    <input type="time" id="time" class="form-input" required>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label" for="notes">Notes (Optional)</label>
                <textarea id="notes" class="form-textarea" placeholder="Any additional thoughts about this seltzer..."></textarea>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goBack()">Cancel</button>
                <button type="submit" class="btn btn-primary">Update Seltzer</button>
            </div>
        </form>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="confirmation-modal" id="deleteModal">
    <div class="modal-content">
        <div class="modal-title">Delete Seltzer</div>
        <div class="modal-text">Are you sure you want to delete this seltzer? This action cannot be undone.</div>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-cancel" onclick="hideDeleteModal()">Cancel</button>
            <button class="modal-btn modal-btn-confirm" onclick="confirmDelete()">Delete</button>
        </div>
    </div>
</div>

<div class="nav-bar">
    <a href="{{ url_for('index') }}" class="nav-item">
        <div class="nav-icon">üè†</div>
        <div>Home</div>
    </a>
    <a href="{{ url_for('log') }}" class="nav-item">
        <div class="nav-icon">üìù</div>
        <div>Log</div>
    </a>
    <a href="{{ url_for('history') }}" class="nav-item">
        <div class="nav-icon">üìä</div>
        <div>History</div>
    </a>
    <a href="{{ url_for('search') }}" class="nav-item">
        <div class="nav-icon">üîç</div>
        <div>Search</div>
    </a>
    <a href="{{ url_for('profile') }}" class="nav-item">
        <div class="nav-icon">üë§</div>
        <div>Profile</div>
    </a>
</div>
{% endblock %}

{% block scripts %}
<script>
let brands = [];
let currentRating = 0;
let seltzerId = '{{ seltzer_id }}';
let seltzerData = null;

// Load brands from API
async function loadBrands() {
    try {
        const response = await fetch('/api/brands');
        brands = await response.json();
        
        const brandSelect = document.getElementById('brand');
        brands.forEach(brand => {
            const option = document.createElement('option');
            option.value = brand.id;
            option.textContent = brand.name;
            brandSelect.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading brands:', error);
    }
}

// Load seltzer data
async function loadSeltzerData() {
    try {
        const response = await fetch(`/api/seltzers/${seltzerId}`);
        if (response.ok) {
            seltzerData = await response.json();
            populateForm(seltzerData);
        } else {
            alert('Seltzer not found');
            goBack();
        }
    } catch (error) {
        console.error('Error loading seltzer data:', error);
        alert('Error loading seltzer data');
        goBack();
    }
}

// Populate form with existing data
function populateForm(data) {
    document.getElementById('brand').value = data.brand_id;
    loadFlavors();
    setTimeout(() => {
        document.getElementById('flavor').value = data.flavor_id;
    }, 100);
    
    currentRating = data.rating;
    updateStars();
    
    document.getElementById('date').value = data.date;
    document.getElementById('time').value = data.time;
    document.getElementById('notes').value = data.notes || '';
}

// Load flavors based on selected brand
function loadFlavors() {
    const brandSelect = document.getElementById('brand');
    const flavorSelect = document.getElementById('flavor');
    const selectedBrand = brandSelect.value;

    // Clear existing options
    flavorSelect.innerHTML = '<option value="">Select a flavor...</option>';

    if (selectedBrand) {
        const brand = brands.find(b => b.id === selectedBrand);
        if (brand) {
            // Enable flavor select
            flavorSelect.disabled = false;
            
            // Add flavor options
            brand.flavors.forEach(flavor => {
                const option = document.createElement('option');
                option.value = flavor.toLowerCase().replace(/\s+/g, '-');
                option.textContent = flavor;
                flavorSelect.appendChild(option);
            });
        }
    } else {
        // Disable flavor select
        flavorSelect.disabled = true;
        flavorSelect.innerHTML = '<option value="">Select a brand first...</option>';
    }
}

// Star rating functionality
const stars = document.querySelectorAll('.star');

stars.forEach((star, index) => {
    star.addEventListener('click', () => {
        currentRating = index + 1;
        updateStars();
    });

    star.addEventListener('mouseenter', () => {
        highlightStars(index + 1);
    });
});

document.querySelector('.rating-container').addEventListener('mouseleave', () => {
    updateStars();
});

function highlightStars(rating) {
    stars.forEach((star, index) => {
        star.classList.toggle('active', index < rating);
    });
}

function updateStars() {
    highlightStars(currentRating);
}

// Form submission
document.getElementById('editSeltzerForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const brandSelect = document.getElementById('brand');
    const flavorSelect = document.getElementById('flavor');
    
    const formData = {
        brand: brandSelect.options[brandSelect.selectedIndex].text,
        brand_id: brandSelect.value,
        flavor: flavorSelect.options[flavorSelect.selectedIndex].text,
        flavor_id: flavorSelect.value,
        rating: currentRating,
        date: document.getElementById('date').value,
        time: document.getElementById('time').value,
        notes: document.getElementById('notes').value
    };

    try {
        const response = await fetch(`/api/seltzers/${seltzerId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (response.ok) {
            alert('Seltzer updated successfully!');
            goBack();
        } else {
            alert('Error updating seltzer. Please try again.');
        }
    } catch (error) {
        console.error('Error updating seltzer:', error);
        alert('Error updating seltzer. Please try again.');
    }
});

// Delete functionality
function showDeleteModal() {
    document.getElementById('deleteModal').style.display = 'flex';
}

function hideDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

async function confirmDelete() {
    try {
        const response = await fetch(`/api/seltzers/${seltzerId}`, {
            method: 'DELETE'
        });

        if (response.ok) {
            alert('Seltzer deleted successfully!');
            goBack();
        } else {
            alert('Error deleting seltzer. Please try again.');
        }
    } catch (error) {
        console.error('Error deleting seltzer:', error);
        alert('Error deleting seltzer. Please try again.');
    }
    
    hideDeleteModal();
}

function goBack() {
    window.location.href = '{{ url_for("history") }}';
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', async function() {
    await loadBrands();
    await loadSeltzerData();
});
</script>
{% endblock %}
